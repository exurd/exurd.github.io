!function(e){"use strict";class t{constructor(){}}class s{constructor(e){this.pendingLogLines=0;let t=[],s=0;for(;s<62;)++s,t.push(0);this.downloadCountBucket=t,this.logLines=[],this.clusterizeRows=[],this.ident=e}fillDownloadCountBucket(){let e=this.itemsDownloaded-this.lastDownloadCount;this.lastDownloadCount=this.itemsDownloaded;let t=(new Date).getSeconds();this.downloadCountBucket[t]=e}computeSpeed(){let e=0,t=0,s=this.downloadCountBucket;for(;t<s.length;)e+=s[t++];return e/60}getTextColor(e){return 200==e.responseCode?"text-success":e.responseCode>=100&&e.responseCode<200?"text-primary":e.responseCode>=201&&e.responseCode<300?"text-success-emphasis":e.responseCode>=300&&e.responseCode<400?"text-info":e.responseCode>=400&&e.responseCode<500?"text-warning":e.responseCode>=500&&e.responseCode<600?"text-danger":e.isWarning?"text-warning":e.isError?"text-danger":null!=e.message||null!=e.pattern?"text-muted":""}consumeLogEvent(e,o){let n=e.job_data;this.aborted=n.aborted,this.bytesDownloaded=s.parseInt(n.bytes_downloaded),this.concurrency=s.parseInt(n.concurrency),this.delayMax=s.parseInt(n.delay_max),this.delayMin=s.parseInt(n.delay_min),this.depth=n.depth,this.errorCount=s.parseInt(n.error_count),this.finished=n.finished,this.finishedAt=s.parseInt(n.finished_at),this.itemsDownloaded=s.parseInt(n.items_downloaded),this.itemsQueued=s.parseInt(n.items_queued),this.note=n.note,this.pipelineId=n.pipeline_id,this.queuedAt=s.parseInt(n.queued_at),this.r1xx=s.parseInt(n.r1xx),this.r2xx=s.parseInt(n.r2xx),this.r3xx=s.parseInt(n.r3xx),this.r4xx=s.parseInt(n.r4xx),this.r5xx=s.parseInt(n.r5xx),this.rUnknown=s.parseInt(n.runk),this.startedAt=s.parseInt(n.started_at),this.startedBy=n.started_by,this.startedIn=n.started_in,this.suppressIgnoreReports=n.suppress_ignore_reports,this.timestamp=s.parseInt(e.ts),this.url=n.url,this.warcSize=n.warc_size;let r=new t;r.type=e.type,r.url=e.url,r.timestamp=s.parseInt(e.ts),r.isError=e.is_error,r.isWarning=e.is_warning,r.responseCode=e.response_code,r.message=e.message,r.pattern=e.pattern,r.wgetCode=e.wget_code,this.totalResponses=this.r1xx+this.r2xx+this.r3xx+this.r4xx+this.r5xx+this.errorCount,this.queueRemaining=this.itemsQueued-this.itemsDownloaded,this.logLines.length>o&&(this.logLines=this.logLines.slice(this.logLines.length-o)),this.fillDownloadCountBucket(),this.responsePerSecond=this.computeSpeed(),this.logLines.push(r),this.pendingLogLines+=1}drawPendingLogLines(e){if(this.pendingLogLines<=0)return;let t=window.document.getElementById("job-log-"+this.ident),s=window.document.getElementById("job-log-content-"+this.ident);if(null==t||null==s)return void(null!=this.clusterize&&(this.clusterize.destroy(!0),this.clusterize=null));if(null!=this.clusterize){(this.clusterize.scroll_elem!=t||this.clusterize.content_elem!=s)&&(this.clusterize.destroy(!0),this.clusterize=null)}if(null==this.clusterize){this.clusterizeRows=[];let e={rows:[],scrollId:"job-log-"+this.ident,contentId:"job-log-content-"+this.ident};this.clusterize=new Clusterize(e)}let o=0,n=this.logLines.slice(-this.pendingLogLines);for(;o<n.length;){let e=n[o];++o;let t=this.getTextColor(e),s="";(e.responseCode>0||null!=e.wgetCode)&&(e.responseCode>0?s+=e.responseCode+" ":s+=e.wgetCode+" "),null!=e.url?(s+='<a href="'+e.url+'" class="job-log-line-url">'+e.url+"</a>",null!=e.pattern&&(s+=' <span class="text-warning">'+e.pattern+"</span>")):null!=e.message&&(s+='<span class="job-log-line-message">'+e.message+"</span>"),s=""!=t?'<div class="job-log-line '+t+'">'+s+"</div>":'<div class="job-log-line">'+s+"</div>",this.clusterizeRows.push(s)}this.clusterizeRows.length>e&&(this.clusterizeRows=this.clusterizeRows.slice(this.clusterizeRows.length-e)),this.clusterize.update(this.clusterizeRows),this.pendingLogLines=0}enforceScrollback(e){this.logLines.length>e&&(this.logLines=this.logLines.slice(this.logLines.length-e)),this.clusterizeRows.length>e&&(this.clusterizeRows=this.clusterizeRows.slice(this.clusterizeRows.length-e),null!=this.clusterize&&this.clusterize.update(this.clusterizeRows))}static parseInt(e){if(null==e)return null;try{return r.parseInt(e)}catch(t){return e}}}class o{constructor(e,t,s,o){null==o&&(o=1e3),null==s&&(s=!1),null==t&&(t=500),this.jobMap=new l,this.jobs=[],this.angular=angular,this.hostname=e,this.maxScrollback=t,this.showNicks=s,this.drawInterval=o,this.app=this.angular.module("dashboardApp",[]);this.app.config(["$compileProvider",function(e){e.debugInfoEnabled(!1)}]),this.app.filter("bytes",function(){return function(e){return e<1024&&e>-1024?(e=Math.round(10*e)/10)+" B":(e/=1024)<1024&&e>-1024?(e=Math.round(10*e)/10)+" KiB":(e/=1024)<1024&&e>-1024?(e=Math.round(10*e)/10)+" MiB":(e/=1024)<1024&&e>-1024?(e=Math.round(10*e)/10)+" GiB":(e/=1024,(e=Math.round(10*e)/10)+" TiB")}});let r=this,i=["$scope",function(e){e.jobs=r.jobs,e.filterQuery="",e.hideDetails=!1,e.paused=!1,e.sortParam="startedAt",e.showNicks=s,e.drawInterval=o,e.currentPage=1,e.pageSize=20,e.totalPages=1,r.dashboardControllerScopeApply=n.field(e,"$apply").bind(e),e.filterOperator=function(t){let s=e.filterQuery;return e.showNicks?!(!t.ident.startsWith(s)&&-1==t.url.indexOf(s))||-1!=t.startedBy.toLowerCase().indexOf(s.toLowerCase()):!!t.ident.startsWith(s)||-1!=t.url.indexOf(s)},r.dashboardControllerScope=e,e.applyFilterQuery=function(t){e.filterQuery=t},e.$watchGroup(["filterQuery","jobs.length"],function(t,s){let o=t[0],n=500;null!=o&&""!=o.trim()||(n=50),r.changeMaxScrollback(n);let i=0,l=r.jobs;for(;i<l.length;)l[i++].enforceScrollback(r.maxScrollback);let a=e.jobs,h=e.filterOperator,c=[],u=0;for(;u<a.length;){let e=a[u];++u,h(e)&&c.push(e)}e.totalPages=0|Math.max(1,Math.ceil(c.length/e.pageSize)),null!=s&&o!=s[0]?e.currentPage=1:e.currentPage>e.totalPages&&(e.currentPage=e.totalPages)}),e.setPage=function(t){t>=1&&t<=e.totalPages&&(e.currentPage=t)}}];this.app.controller("DashboardController",i)}changeMaxScrollback(e){this.maxScrollback=e}run(){this.loadRecentLogs()}loadRecentLogs(){let e=new XMLHttpRequest,t=this;e.onerror=function(e){t.showError("Unable to load dashboard. Reload the page?")},e.onload=function(s){if(200!=e.status)return void t.showError("The server didn't respond correctly: "+e.status+" "+e.statusText);t.showError(null);let o=JSON.parse(e.responseText),n=0;for(;n<o.length;)t.processLogEvent(o[n++]);t.scheduleDraw(),t.openWebSocket()};let s=(new Date).getTime();e.open("GET","http://"+this.hostname+"/logs/recent?cb="+s),e.setRequestHeader("Accept","application/json"),e.send("")}openWebSocket(){if(null!=this.websocket)return;this.websocket=new WebSocket("ws://"+this.hostname+":4568/stream");let e=this;this.websocket.onmessage=function(t){e.showError(null);let s=JSON.parse(t.data);e.processLogEvent(s)},this.websocket.onclose=function(t){null!=e.websocket&&(e.websocket=null,e.showError("Lost connection. Reconnecting..."),setTimeout(function(){e.openWebSocket()},6e4))},this.websocket.onerror=this.websocket.onclose}scheduleDraw(e){null==e&&(e=1e3);let t=this;this.drawTimerHandle=setTimeout(function(){let e=t.dashboardControllerScope.drawInterval;if(!window.document.hidden&&!t.dashboardControllerScope.paused){let s=new Date;t.redraw();let o=(new Date).getTime()-s.getTime();o>10&&(e+=2*o,e=Math.min(e,1e4))}t.scheduleDraw(e)},e)}processLogEvent(e){let t,o=e.job_data.ident;Object.prototype.hasOwnProperty.call(this.jobMap.h,o)?t=this.jobMap.h[o]:(t=new s(o),this.jobMap.h[o]=t,this.jobs.push(t),console.log("Dashboard.hx:566:","Load job "+o)),t.consumeLogEvent(e,this.maxScrollback)}showError(e){let t=window.document.getElementById("message_box");null!=e?(t.style.display="block",t.innerText=e):t.style.display="none"}redraw(){this.dashboardControllerScopeApply();let e=0,t=this.jobs;for(;e<t.length;){let s=t[e];++e,s.logPaused||s.drawPendingLogLines(this.maxScrollback)}this.scrollLogsToBottom()}scrollLogsToBottom(){let e=0,t=this.jobs;for(;e<t.length;){let s=t[e];if(++e,!s.logPaused&&null!=s.clusterize){let e=window.document.getElementById("job-log-"+s.ident);null!=e&&(e.scrollTop=e.scrollHeight)}}}static getQueryArgs(){let t=e.location.search,s=i.replace(t,"?","").split("&"),o=new l,n=0;for(;n<s.length;){let e=s[n++].split("=");o.h[e[0]]=e[1]}return o}static main(){let e,t=o.getQueryArgs(),s=Object.prototype.hasOwnProperty.call(t.h,"showNicks");e=Object.prototype.hasOwnProperty.call(t.h,"host")?t.h.host:"archivebot.com",new o(e,50,s).run()}}class n{static field(e,t){try{return e[t]}catch(e){return null}}}class r{static parseInt(e){let t=parseInt(e);return isNaN(t)?null:t}}class i{static replace(e,t,s){return e.split(t).join(s)}}class l{constructor(){this.h=Object.create(null)}}o.main()}("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this);